<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>为你的游戏定制lua</title>
  <meta name="description"
    content="  由于lua解释执行，且是一款轻量级的脚本语言，所以作为脚本无数次被广大游戏项目采用。市面上lua插件多如牛毛，像nlua,ulua,slua,xlua,tolua。 每一款插件或多或少有这样或那样的优点缺点。 我觉得王道就是自己写一个lua插件，定制给游戏，游戏需要什么功能，就加入什么功能，移除不必要的模块，...">

  <link rel="shortcut icon" href="/img/favicon.ico">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://huailiang.github.io/blog/2018/ulua/">

</head>

<body>
  <main>
    <header class="site-header">
  <div class="container">
    <h1><a href="/">Hom<span>e</span></a></h1>

    <button type="button" class="sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <nav class="navbar sliding-panel-content">
      <ul>
        
        <li><a href="/about" title="About">About</a>
        </li>
        
        <li><a href="/blog" title="Blog">Blog</a>
        </li>
        
       <li><a href="/category/" target="_blank"><i class="icon icon-feed"></i></a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="sliding-panel-fade-screen"></div>
    <script type="text/javascript" src="/js/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    processEscapes: true
  }
});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });

</script>
    <div class="container">
      <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">为你的游戏定制lua</h1>
      <p class="post-meta">Oct 2, 2018 •
        Huailiang</p>
    </header>

    <div class="post-content">
      <blockquote>
  <p>由于lua解释执行，且是一款轻量级的脚本语言，所以作为脚本无数次被广大游戏项目采用。市面上lua插件多如牛毛，像nlua,ulua,slua,xlua,tolua。 每一款插件或多或少有这样或那样的优点缺点。 我觉得王道就是自己写一个lua插件，定制给游戏，游戏需要什么功能，就加入什么功能，移除不必要的模块，加入自己需要的模块。</p>
</blockquote>

<p>本文对应到github工程代码地址：<a href="https://github.com/huailiang/ulua_proj">https://github.com/huailiang/ulua_proj</a></p>

<h2 id="为什么要定制">为什么要定制</h2>

<ol>
  <li>
    <p>移除不必要的模块，比如说luasocket，qllite这些，加入些新的特性，比如说lua protobuf3.x</p>
  </li>
  <li>
    <p>主流的lua插件都是针对c#的代码修复，越来越多的游戏逻辑移植到c++里，定制就意味着可以和引擎逻辑编入同一个库中，自然可以用来修复c++里的模块</p>
  </li>
</ol>

<h2 id="为什么选择lua53">为什么选择lua53</h2>

<p>为什么选择lua53, 而不是效率更高的luajit。 主要是考虑到项目使用lua来修复既有的逻辑模块，而不是使用lua来开发新的模块。（不是绝对的使用lua不开发新功能，比如说活动系统这种频繁更新的模块可以使用lua来开发，只是这种需求比较少，而且对性能要求不高）</p>

<p>还有一个原因是使用lua53，是因为lua53天然支持int64，游戏逻辑使用c#,c++这种高阶语言编写的，很容易用到int64这种数据格式。</p>

<h2 id="编译lua源码踩的坑">编译lua源码踩的坑</h2>

<ul>
  <li>ios build error: ‘system’ is unavailable: not available on iOS<br />
iOS11废除了system之后,rug如果使用xcode9以上的版本编译都会报此错误，解决方法就是：<br />
将loslib.c中</li>
</ul>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span></code></pre></figure>

<p>改为:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">nftw</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">unlink_cb</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">FTW_DEPTH</span> <span class="o">|</span> <span class="n">FTW_PHYS</span><span class="p">);</span></code></pre></figure>

<p>引入头文件</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;ftw.h&gt;</span></code></pre></figure>

<p>添加方法:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">unlink_cb</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fpath</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">stat</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">typeflag</span><span class="p">,</span> <span class="k">struct</span> <span class="n">FTW</span>     <span class="o">*</span><span class="n">ftwbuf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">remove</span><span class="p">(</span><span class="n">fpath</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span>
        <span class="n">perror</span><span class="p">(</span><span class="n">fpath</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>ftw.h当然这是ios平台才有的头文件，所以你使用同一份代码编译编译Android的时候又会发现此文件找不到，所以可以使用#ifdef IOS 这样的宏区分开来。</p>

<ul>
  <li>Android build error: struct lconv has no…‘decimal_point’</li>
</ul>

<p>查询msdn，后知道：char *decimal_point, wchar_t *_W_decimal_point, Decimal-point character for nonmonetary quantities.对于非货币数量的小数点字符。</p>

<p><img src="/img/post-lua/lua5.jpg" alt="" /></p>

<p>于是将错误的地址进行如下修改：</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#ifdef WIN32
</span>
       <span class="n">lcc</span> <span class="o">=</span> <span class="n">localeconv</span><span class="p">();</span>   <span class="cm">/* set structure containing local decimal point symbol */</span>
       <span class="n">decimalpt</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">lcc</span><span class="o">-&gt;</span><span class="n">decimal_point</span><span class="p">);</span>
<span class="cp">#else
</span>
       <span class="n">decimalpt</span> <span class="o">=</span> <span class="sc">'.'</span><span class="p">;</span>
<span class="cp">#endif</span></code></pre></figure>

<p>效果如下：</p>

<p><img src="/img/post-lua/lua4.jpg" alt="" /></p>

<ul>
  <li>当然还有很多android还有类似log2的build error错误，后来我们决定采用类似xlua的套路：</li>
</ul>

<p>把差异化的东西编译到link文件，然后cmakelist这样配置：</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">configure_file</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">LUA_SRC_PATH</span><span class="p">}</span><span class="o">/</span><span class="n">luaconf.h.in</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">CMAKE_CURRENT_BINARY_DIR</span><span class="p">}</span><span class="o">/</span><span class="n">luaconf.h</span><span class="w"> </span><span class="p">)</span></code></pre></figure>

<h2 id="protobuf">Protobuf</h2>

<p>最让我抓狂的是google官方居然不支持Lua版的protobuf。ulua,tolua使用的都是云风的gen_lua_protoc这款插件。但是gen_lua_protoc虽然支持protobuf, 但是只支持到protobuf 2.x版本。而且对应的lua版本也是lua5.1。</p>

<p>xlua官方的github 工程中并没有支持到protobuf，  不过xlua的作者在自己的blog 集成了第三方protobuf3.x, , 然并没有发布到腾讯官方的公布的工程中。 xlua作者提供的xlua扩展工程叫build_xlua_with_libs，如果读者感兴趣，可以点击这里，<a href="https://github.com/chexiongsheng/build_xlua_with_libs">查看源码</a>。</p>

<p><img src="/img/post-lua/xLua.png" alt="i2" /></p>

<p>lua虽然支持了protobuf, 而且同时支持了2.x和3.x两个版本。但是依旧解决不了我项目的问题。 首先socket的收发协议都在c#。 c++ 和lua 模块中如果需要处理网络消息，都需要bytes来中转。xlua 就没有像ulua,tolua那样提供类似的功能。（其实ulua和tolua的处理归根结底还是gen_lua_protoc处理的）。</p>

<p>于是我使用ulua的方式导出LuaStringBuf的方式，把LuaStringBuf传递给lua,lua接受到参数后，作为data使用pb.decode去反序列化，居然成功了。</p>

<p>类似的我想把lua中序列化的对象传递给c#, c#却不认了。c#识别的是string对象。于是我不得转变思路。通过查看<a href="https://github.com/starwing/lua-protobuf">lua-protobuf源码</a>，我了解到lua在序列化的时候(pb.encode),是向堆栈上lua_pushlstring，这个字符串是不随’\0’ 来结束的，说白了就是一串指定长度的unsigned char,对应到c#的byte[]。 我使用的方式的就是把string每个字符转成byte存到table中，然后传递到c#中对应的类型是LuaTable。 c#拿到之后再转换为byte[]。 最后使用此byte[]在c#反序列化。从<a href="https://github.com/huailiang/ulua_proj">例子</a>里可以看到反序列化的结果。</p>

<h2 id="bytecode">ByteCode</h2>

<p>Lua 导出bytecode</p>

<p>lua使用bytecode 的好处主要有两点：</p>

<div class="highlighter-rouge"><pre class="highlight"><code> a. 二进制文件，为了加密
 b. 编译后的中间件，提升效率
</code></pre>
</div>

<p>那么如何导出bytecode呢？</p>

<ul>
  <li>luajit</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>a. 进入luajit\LuaJIT-2.0.1\src 目录

b. uajit -b 需要编译的lua文件路径 编译输出文件保存路径

</code></pre>
</div>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># luajit -b d:\src.lua d:\des.lua</span>
luajit -b d:<span class="se">\s</span>rc.lua d:<span class="se">\d</span>es.lua</code></pre></figure>

<ul>
  <li>luac (mac下)</li>
</ul>

<p>运行下面命令</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">curl -R -O http://www.lua.org/ftp/lua-5.3.1.tar.gz 
tar zxf lua-5.3.1.tar.gz 
<span class="nb">cd </span>lua-5.3.1 
make macosx <span class="nb">test</span></code></pre></figure>

<p>安装, 输入以下命令，会要求输入Password: 输入相应密码（你的密码），然后回车就自动安装了</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">sudo make install</code></pre></figure>

<p>配置编译器 sublime下执行Tools-&gt;Build System-&gt;New Build System 输入：</p>

<p>{ <br />
“cmd”: [“/usr/local/bin/lua”, “$file”], <br />
“file_regex”: “^(…?):([0-9]):?([0-9]*)”, <br />
“selector”: “source.lua”<br />
} <br />
保存为Lua.sublime-build，然后Tools-Build System上就能选择lua来编译脚本了</p>

<p>luac生成bytecode, 使用如下命令：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">luac -o test.luac test.lua</code></pre></figure>

<p>注意：</p>

<p>如果项目在PC下正常运行，但是安装到Android手机就报错：ulua.lua: cannot load incompatible bytecode，那么说明你的运行时luajit和编译时luajit版本不一致，你需要删除LuaEncoder文件夹下的luajit，然后，把LuaFramework下的luajit拷贝过来，然后在运行就可以了。</p>

<p>如果运行时候出现这个报错</p>

<p>LuaException: error loading module Main from CustomLoader,<br />
Main: size_t size mismatch in precompiled chunk<br />
解决： 所使用的luac编译工具得区分32、64位 , 安卓需在32位的编译文件</p>

<p>https://github.com/Tencent/xLua/issues/356<br />
https://www.jianshu.com/p/3c49cf454502</p>

<h2 id="结语">结语</h2>

<p>好久没有更新博客了，最近的项目工作量上来了，之后相信会越来越忙了，祝大家工作顺利。</p>


    </div>
  </div>

  <style>
  .post-nav {
    overflow: hidden;
    /* margin-top: 60px; */
    padding: 12px;
    white-space: nowrap;
    /* border-top: 1px solid #eee; */
  }

  .post-nav-item {
    display: inline-block;
    width: 50%;
    white-space: normal;
  }

  .post-nav-item a {
    position: relative;
    display: inline-block;
    line-height: 25px;
    font-size: 14px;
    color: #555;
    border-bottom: none;
  }

  .post-nav-item a:hover {
    color: #222;
    font-weight: bold;
    border-bottom: none;
  }

  .post-nav-item a:active {
    top: 2px;
  }

  .post-nav-item a:before,
  .post-nav-item a:after {
    display: inline-block;
    width: 16px;
    height: 25px;
    vertical-align: top;
    opacity: 0.4;
    background-size: 16px;
  }

  .post-nav-none a:none {
    content: ' ';
    background-size: 8px;
  }

  .post-nav-none a:hover:none {
    opacity: 1;
  }

  .post-nav-prev a:before {
    content: ' ';
    background: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjxzdmcgaGVpZ2h0PSIxMnB4IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA5IDEyIiB3aWR0aD0iOXB4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnNrZXRjaD0iaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoL25zIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PHRpdGxlLz48ZGVzYy8+PGRlZnMvPjxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCIgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiPjxnIGZpbGw9IiMwMDAwMDAiIGlkPSJDb3JlIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjE4LjAwMDAwMCwgLTkwLjAwMDAwMCkiPjxnIGlkPSJjaGV2cm9uLWxlZnQiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIxOC41MDAwMDAsIDkwLjAwMDAwMCkiPjxwYXRoIGQ9Ik03LjQsMS40IEw2LDAgTC04Ljg4MTc4NDJlLTE2LDYgTDYsMTIgTDcuNCwxMC42IEwyLjgsNiBMNy40LDEuNCBaIiBpZD0iU2hhcGUiLz48L2c+PC9nPjwvZz48L3N2Zz4=") no-repeat 0 50%;
    background-size: 8px;
  }

  .post-nav-prev a:hover:before {
    opacity: 1;
  }

  .post-nav-next {
    text-align: right;
  }

  .post-nav-next a:after {
    content: ' ';
    background: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjxzdmcgaGVpZ2h0PSIxMnB4IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA5IDEyIiB3aWR0aD0iOXB4IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnNrZXRjaD0iaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoL25zIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PHRpdGxlLz48ZGVzYy8+PGRlZnMvPjxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCIgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiPjxnIGZpbGw9IiMwMDAwMDAiIGlkPSJDb3JlIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMjYwLjAwMDAwMCwgLTkwLjAwMDAwMCkiPjxnIGlkPSJjaGV2cm9uLXJpZ2h0IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyNjAuNTAwMDAwLCA5MC4wMDAwMDApIj48cGF0aCBkPSJNMSwwIEwtMC40LDEuNCBMNC4yLDYgTC0wLjQsMTAuNiBMMSwxMiBMNyw2IEwxLDAgWiIgaWQ9IlNoYXBlIi8+PC9nPjwvZz48L2c+PC9zdmc+") no-repeat 100% 50%;
    background-size: 8px;
  }

  .post-nav-next a:hover:after {
    opacity: 1;
  }
</style>



<div class="post-nav">

  
  <div class="post-nav-prev post-nav-item">
    
    <a href="/blog/2018/ppo/"> 强化学习-游戏AI Trainning (三)</a>
  </div>
  

  
  <div class="post-nav-next post-nav-item">
    
    <a href="/blog/2018/pbr/"> PBR基于物理的着色</a>
  </div>
  

</div>

</article>
    </div>

    <footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="https://twitter.com/penghuailiang" target="_blank"><i class="icon icon-twitter"></i></a></li>
  <li><a href="https://www.zhihu.com/people/huailiangpenguin" target="_blank"><i class="icon icon-zhihu"></i></a></li>
  <li><a href="https://www.facebook.com/profile.php?id=100004290725320" target="_blank"><i class="icon icon-facebook"></i></a></li>
  <li><a href="https://weibo.com/6212299692/profile?topnav=1&wvr=6" target="_blank"><i class="icon icon-sina"></i></a></li>
  <li><a href="https://www.linkedin.com/in/penghuailiang/" target="_blank"><i class="icon icon-linkedin"></i></a></li>
  <li><a href="https://github.com/huailiang" target="_blank"><i class="icon icon-github"></i></a></li>
</ul>
    <p class="txt-medium-gray">
      <small>&copy;2021 All rights reserved. </small>
    </p>
  </div>
</footer>
    <a href="https://github.com/huailiang" target="_blank" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#337ab7; color:#fff; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <script>
      $(document).ready(function () {
        $('.sliding-panel-button,.sliding-panel-fade-screen,.sliding-panel-close').on('click touchstart', function (e) {
          $('.sliding-panel-content,.sliding-panel-fade-screen').toggleClass('is-visible');
          e.preventDefault();
        });
      });
    </script>
  </main>
</body>

</html>